name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: true
        default: 'develop'

env:
  ENVIRONMENT: staging
  CLUSTER: staging-cluster
  NAMESPACE: testrails-staging

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.testrails.example.com
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_STAGING }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_STAGING }}
          aws-region: us-east-1

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --name ${{ env.CLUSTER }} --region us-east-1

      - name: Set image tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "backend_tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
            echo "frontend_tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "backend_tag=develop-${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "frontend_tag=develop-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Kubernetes
        run: |
          # Update backend deployment
          kubectl set image deployment/backend \
            backend=ghcr.io/${{ github.repository }}/backend:${{ steps.tag.outputs.backend_tag }} \
            -n ${{ env.NAMESPACE }}

          # Update frontend deployment
          kubectl set image deployment/frontend \
            frontend=ghcr.io/${{ github.repository }}/frontend:${{ steps.tag.outputs.frontend_tag }} \
            -n ${{ env.NAMESPACE }}

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/backend -n ${{ env.NAMESPACE }} --timeout=5m
          kubectl rollout status deployment/frontend -n ${{ env.NAMESPACE }} --timeout=5m

      - name: Run database migrations
        run: |
          kubectl exec -n ${{ env.NAMESPACE }} deployment/backend -- \
            python manage.py migrate --noinput

      - name: Health check
        run: |
          # Wait for pods to be ready
          kubectl wait --for=condition=ready pod -l app=backend -n ${{ env.NAMESPACE }} --timeout=300s
          kubectl wait --for=condition=ready pod -l app=frontend -n ${{ env.NAMESPACE }} --timeout=300s

          # Check application health endpoint
          kubectl run healthcheck --image=curlimages/curl:latest --rm -i --restart=Never -- \
            curl -f https://staging.testrails.example.com/health || exit 1

      - name: Notify deployment status
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Staging deployment for TestRails: ${{ job.status }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_DEPLOYMENTS }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_DEPLOYMENTS }}
